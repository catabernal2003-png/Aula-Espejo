{% extends "base.html" %}
{% block title %}Mi Espacio — Emprendedor{% endblock %}

{% block content %}
<style>
/* Paleta y variables (consistentes) */
:root{
  --primary: #6366f1;
  --accent: #3b82f6;
  --warm: #fb923c;
  --background: #f8fafc;
  --text: #0f172a;
  --muted: #64748b;
  --card-bg: #ffffff;
  --card-border: #e6eefb;
  --hero-bg: linear-gradient(135deg, rgba(99,102,241,0.16), rgba(59,130,246,0.06));
  --hero-title: #ffffff;
  --hero-sub: rgba(255,255,255,0.92);
  --avatar-gradient: linear-gradient(135deg,#6366f1,#3b82f6);
}

/* Layout */
.dashboard {
  max-width: 1280px;
  margin: 2rem auto;
  display: grid;
  grid-template-columns: 2.2fr 1fr;
  gap: 1.75rem;
  padding: 0 1.25rem;
  color: var(--text);
  background: transparent;
}

/* Dashboard header (welcome) */
.dashboard-header {
  background: var(--hero-bg);
  border-radius: 20px;
  padding: 2rem;
  color: var(--hero-title);
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
  border: 1px solid rgba(255,255,255,0.06);
}

.header-content {
  position: relative;
  z-index: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.welcome-text h1 {
  font-size: 2rem;
  font-weight: 700;
  margin: 0;
  letter-spacing: -0.02em;
  color: var(--hero-title);
}

.welcome-text p {
  font-size: 1rem;
  margin: 0.6rem 0 0;
  color: var(--hero-sub);
  max-width: 680px;
  line-height: 1.5;
}

/* Profile box */
.user-profile {
  text-align: center;
  padding: 1rem;
  background: rgba(255,255,255,0.06);
  border-radius: 12px;
  border: 1px solid rgba(255,255,255,0.06);
}

.avatar {
  width: 72px;
  height: 72px;
  border-radius: 14px;
  background: var(--avatar-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: 700;
  color: white;
  margin: 0 auto 0.6rem;
  box-shadow: 0 8px 20px rgba(99,102,241,0.12);
}

.user-info h3 {
  font-size: 1.05rem;
  font-weight: 600;
  margin: 0;
  color: white;
}

.user-role {
  display: inline-block;
  margin-top: 0.4rem;
  padding: 0.35rem 0.8rem;
  background: rgba(255,255,255,0.08);
  border-radius: 999px;
  color: white;
  font-weight: 600;
  font-size: 0.85rem;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 14px;
  padding: 1.25rem;
  box-shadow: 0 6px 18px rgba(12,18,30,0.04);
  border: 1px solid var(--card-border);
  color: var(--text);
}

.section-title {
  font-weight: 700;
  color: var(--text);
  margin: 0 0 1rem 0;
  display: flex;
  align-items: center;
  gap: 0.6rem;
  font-size: 1.05rem;
}

/* Inputs */
.form-row { display:flex; gap:0.75rem; align-items:center; }
.input, textarea {
  width:100%;
  padding:0.9rem 1rem;
  border-radius:10px;
  font-size:1rem;
  border:1.5px solid var(--card-border);
  color:var(--text);
  background:#fff;
}
.input:focus, textarea:focus {
  outline:none;
  box-shadow:0 8px 30px rgba(99,102,241,0.08);
  border-color:var(--primary);
}
textarea { min-height:96px; resize:vertical; }

/* Resources Grid */
.resources {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1rem;
  margin-top: 0.6rem;
}
.resource {
  padding: 1rem;
  border-radius: 12px;
  background: linear-gradient(to bottom, #ffffff, #fbfdff);
  border: 1px solid var(--card-border);
  transition: transform .18s ease, box-shadow .18s ease;
}
.resource:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(12,18,30,0.06); }
.resource h4 { margin: 0 0 0.5rem; color: var(--text); font-size:1.02rem; }
.resource p { margin:0; color: var(--muted); font-size:0.95rem; }
.resource a { color: var(--primary); font-weight: 700; text-decoration: none; }
.resource a:hover { color: var(--accent); }

/* Metrics */
.metrics { display:grid; grid-template-columns:repeat(3,1fr); gap:0.9rem; margin-top:0.6rem; }
.metric {
  padding: 1rem;
  border-radius: 12px;
  text-align:center;
  background: linear-gradient(180deg,#fbfdff,#f7f9fc);
  border:1px solid var(--card-border);
}
.metric .value { color:var(--primary); font-weight:800; font-size:1.25rem; }
.metric .label { color:var(--muted); font-size:0.9rem; }

/* Projects */
.project {
  padding: 1rem;
  border-radius: 12px;
  border: 1px solid var(--card-border);
  background: #fff;
  margin-bottom: 0.9rem;
}
.project-title { font-weight:700; color:var(--text); font-size:1.05rem; }
.project-desc { color:var(--muted); margin-top:6px; font-size:0.95rem; }

/* Progress */
.progress-track { height:10px; background:#eef6fd; border-radius:999px; overflow:hidden; margin:0.75rem 0; }
.progress-fill { height:100%; background: linear-gradient(90deg,var(--primary),var(--accent)); transition: width .4s ease; }

/* Buttons */
.btn-primary-small { background: linear-gradient(90deg,var(--primary),var(--accent)); color:#fff; padding:0.65rem 0.9rem; border-radius:8px; border:none; cursor:pointer; font-weight:700; }
.btn-neutral { background:#fff; border:1px solid var(--card-border); padding:0.6rem 0.9rem; border-radius:8px; cursor:pointer; color:var(--text); }

/* Chat */
.chat { display:flex; flex-direction:column; gap:0.6rem; height:360px; }
.messages { flex:1; overflow:auto; padding:1rem; background:#fbfdff; border-radius:12px; border:1px solid var(--card-border); }
.msg { padding:0.6rem 0.9rem; border-radius:12px; max-width:86%; margin:0.45rem 0; font-size:0.95rem; line-height:1.35; }
.msg.user { background: rgba(99,102,241,0.08); margin-left:auto; color:var(--text); }
.msg.bot  { background:#fff; border:1px solid var(--card-border); color:var(--text); }

/* Responsive */
@media (max-width:980px){
  .dashboard { grid-template-columns: 1fr; padding: 0 1rem; }
  .metrics { grid-template-columns: repeat(3,1fr); }
}
</style>

<div class="dashboard-header">
  <div class="header-content">
    <div class="welcome-text">
      <h1>Bienvenido, {{ user.username }}</h1>
      <p>Gestiona tus proyectos y aprovecha los recursos disponibles para hacer crecer tu emprendimiento.</p>
    </div>
    
    {# Normalizar acceso a progress para evitar UndefinedError #}
    {% set progress = {} %}
    {% if data is defined %}
      {% if data.progress is defined %}
        {% set progress = data.progress %}
      {% elif 'progress' in data %}
        {% set progress = data['progress'] %}
      {% endif %}
    {% endif %}

    <div class="user-profile">
      <div class="avatar">{{ user.username[0]|upper }}</div>
      <div class="user-info">
        <h3>{{ user.username }}</h3>
        <div class="user-role">{{ user.rol }}</div>
      </div>
    </div>
  </div>

  <div class="quick-stats" style="margin-top:1.25rem; display:grid; grid-template-columns:repeat(3,1fr); gap:1rem;">
    <div class="stat-card card" style="padding:1rem;">
      <div class="stat-value" style="font-size:1.6rem; font-weight:800; color:var(--primary);">{{ progress.level|default(1) }}</div>
      <div class="stat-label" style="color:var(--muted); margin-top:0.5rem;">Nivel Actual</div>
    </div>
    <div class="stat-card card" style="padding:1rem;">
      <div class="stat-value" style="font-size:1.6rem; font-weight:800; color:var(--primary);">{{ progress.points|default(0) }}</div>
      <div class="stat-label" style="color:var(--muted); margin-top:0.5rem;">Puntos</div>
    </div>
    <div class="stat-card card" style="padding:1rem;">
      <div class="stat-value" style="font-size:1.6rem; font-weight:800; color:var(--primary);">{{ progress.badges|default(0) }}</div>
      <div class="stat-label" style="color:var(--muted); margin-top:0.5rem;">Insignias</div>
    </div>
  </div>
</div>

<!-- Sección de fases del programa -->
<div class="card" style="margin-top: 1.5rem; margin-bottom: 2rem;">
  <div class="section-title"><i class="fas fa-route"></i> Fases del Programa</div>
  
  <div class="fases-grid">
    <a href="{{ url_for('fase1_emprendedor') }}" class="fase-card fase1">
      <div class="fase-icon"><i class="fas fa-brain"></i></div>
      <h3>Fase 1</h3>
      <p>Comprensión del negocio y exploración de datos.</p>
    </a>

    <a href="{{ url_for('fase2_emprendedor') }}" class="fase-card fase2">
      <div class="fase-icon"><i class="fas fa-chart-bar"></i></div>
      <h3>Fase 2</h3>
      <p>Modelado y validación de resultados.</p>
    </a>
  </div>
</div>

<style>
/* Fases */
.fases-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 1.2rem;
  margin-top: 1rem;
}

.fase-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  background: linear-gradient(180deg, #ffffff, #f9fbff);
  border: 1px solid var(--card-border);
  border-radius: 14px;
  padding: 1.5rem;
  transition: all 0.25s ease;
  text-decoration: none;
  color: var(--text);
  box-shadow: 0 6px 12px rgba(12,18,30,0.04);
}

.fase-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 22px rgba(99,102,241,0.1);
  border-color: var(--primary);
}

.fase-icon {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  background: var(--avatar-gradient);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1.6rem;
  margin-bottom: 0.8rem;
}

.fase-card h3 {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary);
}

.fase-card p {
  margin-top: 0.4rem;
  color: var(--muted);
  font-size: 0.95rem;
  line-height: 1.45;
}
</style>


<div class="dashboard">
  <!-- Main izquierdo -->
  <div class="card">
    <div class="section-title"><i class="fas fa-lightbulb"></i> Mi Emprendimiento</div>

    <form action="{{ url_for('crear_proyecto_emprendedor') }}" method="post">
      <div class="form-row" style="margin-bottom:0.8rem;">
        <input class="input" name="title" placeholder="Nombre del proyecto" required>
        <button class="btn-primary-small" type="submit">Crear</button>
      </div>
      <textarea name="description" class="input" placeholder="Descripción breve (¿qué hace, para quién?)"></textarea>
    </form>

    <div style="margin-top:1rem;">
      {% if data.projects %}
        {% for p in data.projects %}
          <div class="project">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div class="project-title">{{ p.title }}</div>
              <div style="font-size:0.95rem;color:var(--muted);">Creado: {{ p.created_at[:10] if p.created_at else '' }}</div>
            </div>
            <div class="project-desc">{{ p.description }}</div>

            <div class="progress-track" aria-hidden="true">
              <div class="progress-fill" style="width: {{ p.progress|default(0) }}%;"></div>
            </div>

            <div style="display:flex;justify-content:space-between;align-items:center;">
              <small style="color:var(--muted);">Progreso: {{ p.progress|default(0) }}%</small>
              <div style="display:flex;gap:0.6rem;align-items:center;">
                <button class="btn-primary-small" type="button" onclick="actualizarProgreso({{ p.id }})">Actualizar</button>

                <button class="btn-primary-small" type="button"
                  onclick="analizarExito({{ p.id }}, '{{ p.title|e }}')">
                  Analizar éxito
                </button>

                <form action="{{ url_for('eliminar_proyecto', proj_id=p.id) }}" method="post" style="display:inline;"
                      onsubmit="return confirm('¿Seguro que deseas eliminar el proyecto \"{{ p.title|e }}\"? Esta acción no se puede deshacer.');">
                  <button class="btn-neutral" type="submit">Eliminar</button>
                </form>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div style="text-align:center;padding:1.25rem;color:var(--muted);font-size:1rem;">Aún no tienes proyectos. Crea tu primera idea.</div>
      {% endif %}
    </div>

    <hr style="border:none;border-top:1px solid var(--card-border);margin:1.2rem 0;">

    <div class="section-title"><i class="fas fa-book-open"></i> Recursos</div>
    <div class="resources">
      <div class="resource">
        <h4>Programa de Incubación</h4>
        <p>Fases con actividades guiadas y plantillas. <a href="{{ url_for('programa_incubacion') }}">Ver</a></p>
      </div>
      <div class="resource">
        <h4>Prototipado</h4>
        <p>Guías prácticas para crear prototipos. <a href="{{ url_for('prototipado') }}">Ir</a></p>
      </div>
      <div class="resource">
        <h4>Mentoría</h4>
        <p>Agenda sesiones y envía consultas a mentores. <a href="{{ url_for('mentoria') }}">Ver</a></p>
      </div>
    </div>
  </div>

  <!-- Sidebar derecho -->
  <aside>
    <div class="card" style="margin-bottom:1rem;">
      <div class="section-title"><i class="fas fa-chart-line"></i> Mi Progreso</div>
      <div class="metrics" style="margin-top:0.6rem;">
        <div class="metric"><div class="value">{{ progress.level|default(1) }}</div><div class="label">Nivel</div></div>
        <div class="metric"><div class="value">{{ progress.points|default(0) }}</div><div class="label">Puntos</div></div>
        <div class="metric"><div class="value">{{ progress.badges|default(0) }}</div><div class="label">Insignias</div></div>
      </div>

      <div style="margin-top:1rem;">
        <div style="font-weight:700;color:var(--text);margin-bottom:0.5rem;">Próximas actividades</div>
        {% if data.activities %}
          {% for a in data.activities %}
            <div class="activity"><span>{{ a.title }}</span><span>{{ a.date }}</span></div>
          {% endfor %}
        {% else %}
          <div style="color:var(--muted);">No hay actividades programadas.</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="section-title"><i class="fas fa-robot"></i> Iarbis</div>
      <div style="color:var(--muted);font-size:0.95rem;margin-bottom:0.8rem;">Asistente breve y orientado a recursos.</div>

      <div class="chat">
        <div id="messages" class="messages" aria-live="polite"></div>

        <div class="chat-input" style="display:flex;gap:0.6rem;">
          <input id="chatText" class="input" placeholder="Pregunta sobre el programa, prototipado o mentoría...">
          <button id="sendChat" class="btn-primary-small" type="button"><i class="fas fa-paper-plane"></i></button>
        </div>
      </div>
    </div>
  </aside>
</div>

<script>
// chat funcional (simulado)
(function(){
  const messages = document.getElementById('messages');
  const input = document.getElementById('chatText');
  const send = document.getElementById('sendChat');

  function add(type, text){
    const d = document.createElement('div');
    d.className = 'msg ' + (type==='user' ? 'user' : 'bot');
    d.textContent = text;
    messages.appendChild(d);
    messages.scrollTop = messages.scrollHeight;
  }

  if (!messages.hasChildNodes()) {
    add('bot','Hola. Puedo ayudarte a encontrar recursos y guías. Escribe tu pregunta.');
  }

  function respuesta(p){
    p = p.toLowerCase();
    if (p.includes('incub')) return 'El programa contiene fases: ideación, validación y prototipado. Puedes ver el detalle en "Programa de Incubación".';
    if (p.includes('prototip')) return 'En Prototipado tienes guías y recursos paso a paso para construir un prototipo.';
    if (p.includes('mentor')) return 'En Mentoría verás perfiles y horarios; puedes solicitar una sesión desde ahí.';
    return 'Puedo indicarte recursos o pasos concretos. ¿Qué te interesa: programa, prototipado o mentoría?';
  }

  function sendMessage(){
    const text = input.value.trim();
    if (!text) return;
    add('user', text);
    input.value = '';
    add('bot', 'Procesando…');
    setTimeout(()=>{
      const bots = messages.querySelectorAll('.msg.bot');
      const last = bots[bots.length - 1];
      last.textContent = respuesta(text);
    },600);
  }

  send.addEventListener('click', sendMessage);
  input.addEventListener('keydown', (e)=>{ if (e.key==='Enter') sendMessage(); });
})();

// formatea fechas si son ISO
document.addEventListener('DOMContentLoaded', ()=> {
  document.querySelectorAll('.activity span:last-child').forEach(el=>{
    const t = el.textContent.trim();
    const d = new Date(t);
    if (!isNaN(d)) el.textContent = d.toLocaleDateString('es-ES',{day:'numeric',month:'short'});
  });
});

// actualizar progreso (requiere backend)
function actualizarProgreso(id){
  const v = prompt('Ingrese avance (%) 0-100:');
  const n = parseInt(v);
  if (v === null) return;
  if (!Number.isInteger(n) || n<0 || n>100) { alert('Valor inválido'); return; }
  fetch(`/actualizar-progreso/${id}`, {
    method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({progress:n})
  }).then(r=>r.json()).then(j=>{
    if (j.success) location.reload(); else alert(j.error || 'Error');
  }).catch(()=>alert('Error de conexión'));
}

async function analizarExito(projId, title){
  // mostrar spinner mínimo
  const overlayId = 'analyze-overlay-' + projId;
  // crear caja resultado si no existe
  let box = document.getElementById(overlayId);
  if (!box) {
    box = document.createElement('div');
    box.id = overlayId;
    box.style.position = 'fixed';
    box.style.right = '20px';
    box.style.bottom = '20px';
    box.style.maxWidth = '360px';
    box.style.zIndex = 9999;
    box.style.background = '#fff';
    box.style.border = '1px solid rgba(15,23,42,0.08)';
    box.style.borderRadius = '12px';
    box.style.padding = '14px';
    box.style.boxShadow = '0 10px 30px rgba(12,18,30,0.12)';
    document.body.appendChild(box);
  }
  box.innerHTML = '<strong>Analizando: </strong>' + title + '<div style="margin-top:8px;color:#6b7280">Consultando modelo…</div>';

  try {
    const resp = await fetch(`/predict_success/${projId}`);
    const json = await resp.json();
    if (!json.success) {
      box.innerHTML = '<strong>Error</strong><div style="margin-top:8px;color:#b91c1c">'+ (json.error||'Error desconocido') +'</div>';
      setTimeout(()=>box.remove(), 6000);
      return;
    }
    const r = json.result;
    // format probs
    const probs = r.probs;
    let probsHtml = '<ul style="padding-left:18px;margin:8px 0">';
    for (const cls in probs){
      const pct = (probs[cls]*100).toFixed(1);
      probsHtml += `<li style="margin:4px 0;"><strong>${cls}:</strong> ${pct}%</li>`;
    }
    probsHtml += '</ul>';

    // numeric importance top 3
    const imp = r.numeric_importance || [];
    const impTop = imp.slice(0,3).map(x=>`<li style="margin:4px 0;">${x[0]}: ${parseFloat(x[1]).toFixed(3)}</li>`).join('');

    box.innerHTML = `
      <div style="font-weight:700;margin-bottom:6px;">Resultado — ${r.label}</div>
      <div style="color:#374151;font-size:0.95rem;">Probabilidades:</div>
      ${probsHtml}
      <div style="color:#374151;font-size:0.95rem;margin-top:6px;">Variables (num.) más influyentes:</div>
      <ul style="padding-left:18px;margin:8px 0;">${impTop || '<li style="color:#6b7280">No disponible</li>'}</ul>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
        <button style="background:#ef4444;color:white;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;" onclick="this.parentElement.parentElement.remove()">Cerrar</button>
      </div>
    `;
    // autohide después de cierto tiempo (opcional)
    setTimeout(()=>{ try{ box.remove() }catch(e){} }, 20000);
  } catch (err) {
    box.innerHTML = '<strong>Error de conexión</strong><div style="margin-top:8px;color:#b91c1c">'+ err.message +'</div>';
    setTimeout(()=>box.remove(), 6000);
  }
}
</script>
{% endblock %}

